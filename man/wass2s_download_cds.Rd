% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/wass2s_download_cds.R
\name{wass2s_download_cds}
\alias{wass2s_download_cds}
\title{Robust Parallel Downloader for CDS/ECMWF (via ecmwfr) with Year Chunking}
\usage{
wass2s_download_cds(
  dataset_short_name,
  base_query,
  center_variables,
  years,
  months,
  days,
  times = "00:00",
  leadtime_hour,
  area = c(28.5, -25.5, 4, 26.6),
  out_dir = ".",
  user = "ecmwf",
  service = c("cds", "ads", "cems"),
  filename_tpl = NULL,
  tries = 3,
  sleep_sec = 15,
  timeout_sec = 3600,
  force_download = FALSE,
  parallel = FALSE,
  workers = 2,
  job_name = "default",
  verbose = TRUE,
  ...
)
}
\arguments{
\item{dataset_short_name}{Character. The dataset short name on CDS/ADS/CEMS,
e.g., \code{"seasonal-original-single-levels"}.}

\item{base_query}{Named list. Static part of the query (e.g., \code{product_type},
\code{pressure_level}, \code{format}). Time-varying fields like \code{year},
\code{month}, \code{day}, \code{leadtime_hour} are set by this function.}

\item{center_variables}{Character vector of entries \code{"model_system.variable"},
e.g., \code{"meteo_france_9.TMAX"}, \code{"ecmwf_51.TMAX"}.
Only one variable per entry is supported.}

\item{years}{Integer/character vector. **Required.** Years to request.
When multiple years are provided, requests are split one-per-year.}

\item{months}{Integer/character vector in \code{1..12}. **Required.**}

\item{days}{Character/integer vector (e.g., \code{c("01","02")}). **Required.**}

\item{times}{Character vector (e.g., \code{c("00:00","12:00")}). **Required.**}

\item{leadtime_hour}{Character/integer vector (e.g., \code{c("24","48",...)}). **Required.**}

\item{area}{Optional numeric length-4 \code{c(N, W, S, E)} bounding box.}

\item{out_dir}{Output directory. Created if missing.}

\item{user}{CDS/ADS/CEMS user ID used with \code{ecmwfr::wf_set_key()}.}

\item{service}{One of \code{"cds"}, \code{"ads"}, \code{"cems"} (case-insensitive). Default \code{"cds"}.}

\item{filename_tpl}{Glue-like template for filenames. Placeholders available:
\code{{modelsys}}, \code{{var}}, \code{{init}}, \code{{period}}, \code{{lead}}, \code{{dataset}}, \code{{year}}.
Default: \code{"{modelsys}_{var}_{init}_{period}_{lead}.nc"}.}

\item{tries}{Integer. Number of retry attempts per request (sequential mode). Default \code{3}.}

\item{sleep_sec}{Numeric. Seconds between retries (sequential mode). Default \code{15}.}

\item{timeout_sec}{Numeric. Timeout per request (seconds). Default \code{3600}.
Passed to \code{wf_request()} or \code{wf_request_batch()} as \code{time_out}.}

\item{force_download}{Logical. If \code{FALSE} (default), existing files are skipped.}

\item{parallel}{Logical. If \code{TRUE}, use \code{wf_request_batch()} to submit requests in parallel.
Falls back to sequential mode if batch is unavailable.}

\item{workers}{Integer. Number of parallel workers for batch submission. Default \code{2}.}

\item{job_name}{Optional string passed to \code{wf_request()} (sequential mode).}

\item{verbose}{Logical. Verbose logging. Default \code{TRUE}.}

\item{...}{Additional arguments forwarded to \code{ecmwfr::wf_request()}.}
}
\value{
(Invisibly) a \code{data.frame} with columns:
\itemize{
  \item \code{file} : full path to the output file
  \item \code{status} : one of \code{"ok"}, \code{"skip"}, \code{"fail"}
  \item \code{error} : last error message (if any)
  \item \code{model}, \code{system}, \code{variable}, \code{year}
}
}
\description{
Downloads climate/meteorological data from CDS/ADS/CEMS using \pkg{ecmwfr},
with support for multiple variables and models, robust retries, optional
batch-parallel submission, resume-on-existing files, and clear status reporting.
}
\details{
To comply with CDS request-size limits, when multiple years are provided the
function automatically **splits requests per year** (internal year chunking).
This yields one output file per year. If your \code{filename_tpl} does not
contain \code{{year}}, a \code{_{year}} suffix is appended before the extension
to avoid overwriting.

File naming follows by default:
\preformatted{ModelSystem_Variable_InitDate_Period_Leadtime.nc}
e.g., \code{meteo_france9_TMAX_Apr01_1993_2016_24-5160.nc}
When year-chunking is active and \code{{year}} is not present in the template,
files will be named like \code{..._1993.nc}, \code{..._1994.nc}, etc.
}
\section{Notes}{

\itemize{
  \item Unknown models (not listed in internal \code{VALID_MODELS}) trigger a warning but do not stop execution.
  \item \code{retry} in \code{wf_request_batch()} is a polling interval (seconds), not a count.
  \item Include \code{{year}} in \code{filename_tpl} if you prefer to control where the year appears.
}
}

\examples{
\dontrun{
center_variables <- c("meteo_france_9.TMAX","ecmwf_51.TMAX")
res <- wass2s_download_cds(
  dataset_short_name = "seasonal-original-single-levels",
  base_query = list(format = "netcdf"),
  center_variables = center_variables,
  years = 1993:1995,
  months = 4, days = "01",
  times = "00:00",
  leadtime_hour = seq(24,240,24),
  out_dir = "out",
  parallel = TRUE, workers = 4,
  service = "cds", verbose = TRUE
)
}

}
\seealso{
\code{\link[ecmwfr]{wf_request}}, \code{\link[ecmwfr]{wf_request_batch}}
}
